<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gas Law Particle Simulator</title>

<style>
body {
  margin:0;
  background:#0b0c10;
  color:#e8e8e8;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
.wrap { max-width:1000px; margin:auto; padding:16px; }
.top { display:flex; gap:12px; flex-wrap:wrap; }
.card {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius:16px;
  padding:12px;
}
.controls { min-width:300px; display:grid; gap:10px; }
.row {
  display:grid;
  grid-template-columns:90px 1fr 70px;
  gap:8px;
  align-items:center;
}
input[type=range] { width:100%; }
select {
  grid-column: 2 / span 2;
  background: rgba(255,255,255,0.08);
  color:#e8e8e8;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.15);
  padding:4px;
}
canvas {
  width:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.12);
}
.small { font-size:13px; opacity:.8; }
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="card controls">
      <div class="row"><div>Volume</div><input id="vol" type="range" min="20" max="100" value="70"><div id="volVal"></div></div>
      <div class="row"><div>Temp</div><input id="temp" type="range" min="1" max="100" value="50"><div id="tempVal"></div></div>
      <div class="row"><div>Pressure</div><input id="press" type="range" min="1" max="100" value="35"><div id="pressVal"></div></div>

      <div>Lock</div>
      <select id="lock">
        <option value="none">None</option>
        <option value="volume">Volume</option>
        <option value="temp">Temperature</option>
        <option value="pressure">Pressure</option>
      </select>

      <div class="small">Keeps <b>P × V / T</b> constant</div>
    </div>

    <div class="card">
      <div id="stats"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <canvas id="c" width="900" height="560"></canvas>
  </div>
</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const volEl = document.getElementById("vol");
const tempEl = document.getElementById("temp");
const pressEl = document.getElementById("press");
const lockEl = document.getElementById("lock");

const volVal = document.getElementById("volVal");
const tempVal = document.getElementById("tempVal");
const pressVal = document.getElementById("pressVal");
const stats = document.getElementById("stats");

const R = 4;
const drag = 0.999;
const restitution = 0.98;
const maxParticles = 260;

let particles = [];
let gasConstant = (Number(pressEl.value)*Number(volEl.value))/Math.max(1,Number(tempEl.value));
let lockedValue = null;

// ---------------- utilities ----------------
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const lerp = (a,b,t)=>a+(b-a)*t;
const rand = (a,b)=>a+Math.random()*(b-a);

// ---------------- gas law ----------------
const P = ()=>Number(pressEl.value);
const V = ()=>Number(volEl.value);
const T = ()=>Math.max(1,Number(tempEl.value));

// ---------------- container ----------------
function getBox(){
  const t = (V()-20)/80;
  const m = lerp(220,40,t);
  return { l:m, r:canvas.width-m, t:m*0.75, b:canvas.height-m*0.75 };
}

// ---------------- particles ----------------
function makeParticle(box){
  const a = Math.random()*Math.PI*2;
  const s = rand(0.4,1);
  return { x:rand(box.l+R,box.r-R), y:rand(box.t+R,box.b-R), vx:Math.cos(a)*s, vy:Math.sin(a)*s };
}

function ensureParticles(){
  const box = getBox();
  const area = (box.r-box.l)*(box.b-box.t);
  const maxByArea = Math.floor((area*0.45)/(Math.PI*R*R));
  const target = Math.min(Math.round(lerp(20,maxParticles,P()/100)), maxByArea);
  while(particles.length<target) particles.push(makeParticle(box));
  while(particles.length>target) particles.pop();
}

function resolveCollisions(){
  for(let i=0;i<particles.length;i++){
    for(let j=i+1;j<particles.length;j++){
      const a=particles[i],b=particles[j];
      const dx=b.x-a.x,dy=b.y-a.y,d2=dx*dx+dy*dy,md=R*2;
      if(d2>0 && d2<md*md){
        const d=Math.sqrt(d2),nx=dx/d,ny=dy/d,o=(md-d)*0.5;
        a.x-=nx*o; a.y-=ny*o; b.x+=nx*o; b.y+=ny*o;
        const rvx=b.vx-a.vx,rvy=b.vy-a.vy,vn=rvx*nx+rvy*ny;
        if(vn<0){ const imp=-vn; a.vx-=imp*nx; a.vy-=imp*ny; b.vx+=imp*nx; b.vy+=imp*ny; }
      }
    }
  }
}

// ---------------- apply lock ----------------
function applyGasLaw(changed){
  const lock = lockEl.value;
  if(lock === "none") return;

  if(lock === "volume"){
    volEl.value = lockedValue; // freeze volume
    if(changed === "pressure"){
      const targetTemp = (P()*lockedValue)/gasConstant;
      const clampedTemp = clamp(targetTemp,1,100);
      tempEl.value = clampedTemp;
      if(clampedTemp !== targetTemp){
        pressEl.value = clamp((gasConstant*clampedTemp)/lockedValue,1,100);
      }
    }
    if(changed === "temp"){
      const targetPress = (gasConstant*T())/lockedValue;
      const clampedPress = clamp(targetPress,1,100);
      pressEl.value = clampedPress;
      if(clampedPress !== targetPress){
        tempEl.value = clamp((clampedPress*lockedValue)/gasConstant,1,100);
      }
    }
  }

  if(lock === "temp"){
    tempEl.value = lockedValue; // freeze temp
     if(changed === "pressure"){
      const targetVol = (gasConstant*lockedValue)/P();
      const clampedVol = clamp(targetVol,20,100);
      volEl.value = clampedVol;
      if(clampedVol !== targetVol){
        pressEl.value = clamp((gasConstant*lockedValue)/clampedVol,1,100);
      }
    }
    if(changed === "volume"){
      const targetPress = (gasConstant*lockedValue)/V();
      const clampedPress = clamp(targetPress,1,100);
      pressEl.value = clampedPress;
      if(clampedPress !== targetPress){
        volEl.value = clamp((gasConstant*lockedValue)/clampedPress,20,100);
      }
    }
  }

  if(lock === "pressure"){
    pressEl.value = lockedValue; // freeze pressure
    if(changed === "volume"){
      const targetTemp = (lockedValue*V())/gasConstant;
      const clampedTemp = clamp(targetTemp, 1, 100);
      tempEl.value = clampedTemp;
      if(clampedTemp !== targetTemp){
        volEl.value = clamp((gasConstant*clampedTemp)/lockedValue, 20, 100);
      }
    }
    if(changed === "temp"){
      const targetVol = (gasConstant*T())/lockedValue;
      const clampedVol = clamp(targetVol, 20, 100);
      volEl.value = clampedVol;
      if(clampedVol !== targetVol){
        tempEl.value = clamp((lockedValue*clampedVol)/gasConstant, 1, 100);
      }
    }
  }
}

// ---------------- input handlers ----------------
// Only apply changes if the slider is NOT locked
volEl.addEventListener("input", ()=>{ if(lockEl.value !== "volume") applyGasLaw("volume"); });
tempEl.addEventListener("input", ()=>{ if(lockEl.value !== "temp") applyGasLaw("temp"); });
pressEl.addEventListener("input", ()=>{ if(lockEl.value !== "pressure") applyGasLaw("pressure"); });

lockEl.addEventListener("change", ()=>{
  const lock = lockEl.value;
  if(lock === "none"){
    lockedValue = null;
    gasConstant = (P()*V())/T();
  } else if(lock === "volume") lockedValue = V();
  else if(lock === "temp") lockedValue = T();
  else if(lock === "pressure") lockedValue = P();

  gasConstant = (P()*V())/T();
});

// ---------------- loop ----------------
function step(){
  ensureParticles();

  const box=getBox();
  const speed=lerp(0.4,3.2,T()/100);
  const maxSpeed=8*speed;

  for(let s=0;s<3;s++){
    for(const p of particles){
      const m=Math.hypot(p.vx,p.vy)||0.0001;
      p.vx=(p.vx/m)*lerp(m,speed,0.02);
      p.vy=(p.vy/m)*lerp(m,speed,0.02);

      const sp=Math.hypot(p.vx,p.vy);
      if(sp>maxSpeed){ p.vx=p.vx/sp*maxSpeed; p.vy=p.vy/sp*maxSpeed; }

      p.x+=p.vx/3; p.y+=p.vy/3;

      if(p.x<box.l+R){p.x=box.l+R;p.vx=Math.abs(p.vx)*restitution;}
      if(p.x>box.r-R){p.x=box.r-R;p.vx=-Math.abs(p.vx)*restitution;}
      if(p.y<box.t+R){p.y=box.t+R;p.vy=Math.abs(p.vy)*restitution;}
      if(p.y>box.b-R){p.y=box.b-R;p.vy=-Math.abs(p.vy)*restitution;}

      p.vx*=drag; p.vy*=drag;
    }
    resolveCollisions();
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="rgba(255,255,255,.3)";
  ctx.strokeRect(box.l,box.t,box.r-box.l,box.b-box.t);

  let avg=0;
  for(const p of particles){
    avg+=Math.hypot(p.vx,p.vy);
    ctx.beginPath();
    ctx.arc(p.x,p.y,R,0,Math.PI*2);
    ctx.fillStyle="rgba(120,200,255,.9)";
    ctx.fill();
  }

  stats.innerHTML=
    `Particles: ${particles.length}<br>
     Avg speed: ${(avg/particles.length).toFixed(2)}<br>
     P×V/T = ${gasConstant.toFixed(2)}`;

  volVal.textContent=V().toFixed(1);
  tempVal.textContent=T().toFixed(1);
  pressVal.textContent=P().toFixed(1);

  requestAnimationFrame(step);
}

step();
</script>
</body>
</html>
